const { cmd } = require("../command");
const axios = require("axios");
const yts = require("yt-search");
const config = require("../config");

cmd({
    pattern: "song",
    alias: ["yta", "mp3", "play"],
    react: "üéß",
    desc: "Download YouTube MP3 with selection menu",
    category: "download",
    filename: __filename,
}, async (bot, mek, m, { from, q, reply, userSettings, prefix }) => {
    try {
        if (!q) return reply("üéß *ZANTA-MD SONG SEARCH*\n\nExample: .song alone");

        const search = await yts(q);
        const video = search.videos[0];
        if (!video) return reply("‚ùå No results found on YouTube.");

        const settings = userSettings || global.CURRENT_BOT_SETTINGS || {};
        const botName = settings.botName || config.DEFAULT_BOT_NAME || "ZANTA-MD";

        // Reply Menu ‡∂ë‡∂ö ‡∑É‡∂ö‡∑É‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        let msg = `üéµ *ZANTA AUDIO PLAYER* üéµ\n\n` +
                  `üìù *Title:* ${video.title}\n` +
                  `üë§ *Artist:* ${video.author.name}\n` +
                  `‚è±Ô∏è *Duration:* ${video.timestamp}\n` +
                  `üîó *Link:* ${video.url}\n\n` +
                  `*Reply with a number:* \n\n` +
                  `1Ô∏è‚É£ *Audio File* (MPEG)\n` +
                  `2Ô∏è‚É£ *Document File* (MP3)\n\n` +
                  `> *¬© ZANTA-MD SONG SERVICE*`;

        // thumbnail ‡∂ë‡∂ö ‡∑É‡∂∏‡∂ü ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏
        const sentMsg = await bot.sendMessage(from, { 
            image: { url: video.thumbnail }, 
            caption: msg 
        }, { quoted: mek });

        // ‡∂∏‡∑ô‡∂≠‡∂±‡∂Ø‡∑ì index.js ‡∂ë‡∂ö‡∂ß ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏ ‡∑É‡∂≥‡∑Ñ‡∑è caption ‡∂ë‡∂ö‡∂ß ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∂Ω‡∂ö‡∑î‡∂´‡∂ö‡∑ä (üéµ *SONG DOWNLOADER*) ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∑Ñ‡∑ù 
        // ‡∑Ä‡∑ô‡∂±‡∂≠‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∂∏‡∂∫‡∂ö‡∑ä ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∑Ö ‡∑Ñ‡∑ê‡∂ö. 
        // ‡∂±‡∂∏‡∑î‡∂≠‡∑ä ‡∑Ä‡∂©‡∑è‡∂≠‡∑ä ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂ö‡∑ä‚Äç‡∂ª‡∂∏‡∂∫ ‡∑Ä‡∂±‡∑ä‡∂±‡∑ö ‡∑Ä‡∑ô‡∂±‡∂∏‡∂∏ commands ‡∂Ø‡∑ô‡∂ö‡∂ö‡∑ä ‡∑É‡∑è‡∂Ø‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂∫‡∑í.
        
    } catch (e) {
        console.log("SONG ERROR:", e);
        reply("‚ùå *Error:* " + e.message);
    }
});

// --- 1. AUDIO FILE HANDLER ---
cmd({
    pattern: "ytsong_audio",
    dontAddCommandList: true,
    filename: __filename,
}, async (bot, mek, m, { from, q, reply }) => {
    try {
        if (!q) return;
        const finalLink = await getDownloadLink(q);
        if (!finalLink) return reply("‚ùå Download link not found.");

        await bot.sendMessage(from, { 
            audio: { url: finalLink }, 
            mimetype: "audio/mpeg", 
            ptt: false 
        }, { quoted: mek });
        await m.react("‚úÖ");
    } catch (e) { reply("‚ùå Audio Error"); }
});

// --- 2. DOCUMENT FILE HANDLER ---
cmd({
    pattern: "ytsong_doc",
    dontAddCommandList: true,
    filename: __filename,
}, async (bot, mek, m, { from, q, reply }) => {
    try {
        if (!q) return;
        const finalLink = await getDownloadLink(q);
        if (!finalLink) return reply("‚ùå Download link not found.");

        await bot.sendMessage(from, { 
            document: { url: finalLink }, 
            mimetype: "audio/mpeg", 
            fileName: `ZANTA-MD_SONG.mp3`,
            caption: "> *¬© Generated by ZANTA-MD*"
        }, { quoted: mek });
        await m.react("‚úÖ");
    } catch (e) { reply("‚ùå Document Error"); }
});

// --- API Logic ‡∂ë‡∂ö ‡∂¥‡∑ú‡∂Ø‡∑î Function ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ω‡∑ô‡∑É ---
async function getDownloadLink(videoUrl) {
    try {
        // Manul API
        const apiUrl = `https://api-site-x-by-manul.vercel.app/convert?mp3=${encodeURIComponent(videoUrl)}&apikey=Manul-Official`;
        const response = await axios.get(apiUrl);
        if (response.data?.status && response.data.data?.url) return response.data.data.url;

        // Backup API
        const backupUrl = `https://api.giftedtech.my.id/api/download/dlmp3?url=${encodeURIComponent(videoUrl)}&apikey=gifted`;
        const backup = await axios.get(backupUrl);
        return backup.data.result?.download_url;
    } catch (e) {
        return null;
    }
}
