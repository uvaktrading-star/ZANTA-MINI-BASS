const { cmd } = require("../command");
const axios = require("axios");
const yts = require("yt-search");
const config = require("../config");

cmd({
    pattern: "song",
    alias: ["yta", "mp3", "play"],
    react: "üéß",
    desc: "Download YouTube MP3 with selection menu",
    category: "download",
    filename: __filename,
}, async (bot, mek, m, { from, q, reply, prefix }) => {
    try {
        if (!q) return reply("üéß *ZANTA-MD SONG SEARCH*\n\nExample: .song alone");

        const search = await yts(q);
        const video = search.videos[0];
        if (!video) return reply("‚ùå No results found on YouTube.");

        let msg = `üéµ *ZANTA AUDIO PLAYER* üéµ\n\n` +
                  `üìù *Title:* ${video.title}\n` +
                  `üë§ *Artist:* ${video.author.name}\n` +
                  `‚è±Ô∏è *Duration:* ${video.timestamp}\n` +
                  `üîó *Link:* ${video.url}\n\n` +
                  `*Reply with a number:* \n\n` +
                  `1Ô∏è‚É£ *Audio File* (MPEG)\n` +
                  `2Ô∏è‚É£ *Document File* (MP3)\n\n` +
                  `> *¬© ZANTA-MD SONG SERVICE*`;

        const sentMsg = await bot.sendMessage(from, { 
            image: { url: video.thumbnail }, 
            caption: msg 
        }, { quoted: mek });

        // --- Reply Listener ‡∂ë‡∂ö ‡∂∏‡∑ô‡∂≠‡∂±‡∑í‡∂±‡∑ä ‡∂¥‡∂ß‡∂±‡∑ä ‡∂ú‡∂±‡∑ì ---
        const listener = async (update) => {
            const msgUpdate = update.messages[0];
            if (!msgUpdate.message) return;

            const body = msgUpdate.message.conversation || 
                         msgUpdate.message.extendedTextMessage?.text || 
                         msgUpdate.message.buttonsResponseMessage?.selectedButtonId;

            // ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏: ‡∂ª‡∑í‡∂¥‡∑ä‡∂Ω‡∂∫‡∑í ‡∂ë‡∂ö ‡∂ö‡∑Ö‡∑ö ‡∂ö‡∂Ω‡∑í‡∂±‡∑ä ‡∂∫‡∑ê‡∑Ä‡∑ñ ‡∂∏‡∑ê‡∑É‡∑ö‡∂¢‡∑ä ‡∂ë‡∂ö‡∂ß‡∂Ø ‡∑É‡∑Ñ ‡∂Ö‡∂Ç‡∂ö‡∂∫ 1 ‡∑Ñ‡∑ù 2 ‡∂Ø ‡∂ö‡∑í‡∂∫‡∑è
            const isReplyToBot = msgUpdate.message.extendedTextMessage?.contextInfo?.stanzaId === sentMsg.key.id;

            if (isReplyToBot && (body === '1' || body === '2')) {
                await bot.sendMessage(from, { react: { text: '‚è≥', key: msgUpdate.key } });

                try {
                    const finalLink = await getDownloadLink(video.url);
                    if (!finalLink) return reply("‚ùå Download link not found.");

                    if (body === '1') {
                        // Audio ‡∂ë‡∑Ä‡∂±‡∑ä‡∂±
                        await bot.sendMessage(from, { 
                            audio: { url: finalLink }, 
                            mimetype: "audio/mpeg", 
                            ptt: false 
                        }, { quoted: msgUpdate });
                    } else if (body === '2') {
                        // Document ‡∂ë‡∑Ä‡∂±‡∑ä‡∂±
                        await bot.sendMessage(from, { 
                            document: { url: finalLink }, 
                            mimetype: "audio/mpeg", 
                            fileName: `${video.title}.mp3`,
                            caption: "> *¬© Generated by ZANTA-MD*"
                        }, { quoted: msgUpdate });
                    }

                    await bot.sendMessage(from, { react: { text: '‚úÖ', key: msgUpdate.key } });
                } catch (err) {
                    console.error(err);
                    reply("‚ùå Error downloading audio.");
                }

                // ‡∑Ä‡∑ê‡∂©‡∑ö ‡∂â‡∑Ä‡∂ª ‡∑Ä‡∑î‡∂´‡∑è‡∂∏ Listener ‡∂ë‡∂ö ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
                bot.ev.off('messages.upsert', listener);
            }
        };

        // Listener ‡∂ë‡∂ö Register ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        bot.ev.on('messages.upsert', listener);

        // ‡∑Ä‡∑í‡∂±‡∑è‡∂©‡∑í 5‡∂ö‡∂ß ‡∂¥‡∑É‡∑î ‡∂ª‡∑í‡∂¥‡∑ä‡∂Ω‡∂∫‡∑í ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠‡∑ä‡∂±‡∂∏‡∑ä ‡∂â‡∂∂‡∑ö‡∂∏ Listener ‡∂ë‡∂ö ‡∂±‡∂≠‡∂ª ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
        setTimeout(() => {
            bot.ev.off('messages.upsert', listener);
        }, 300000);

    } catch (e) {
        console.log("SONG ERROR:", e);
        reply("‚ùå *Error:* " + e.message);
    }
});

// --- API Logic ‡∂ë‡∂ö ‡∂¥‡∑ú‡∂Ø‡∑î Function ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ω‡∑ô‡∑É ---
async function getDownloadLink(videoUrl) {
    try {
        // Manul API
        const apiUrl = `https://api-site-x-by-manul.vercel.app/convert?mp3=${encodeURIComponent(videoUrl)}&apikey=Manul-Official`;
        const response = await axios.get(apiUrl);
        if (response.data?.status && response.data.data?.url) return response.data.data.url;

        // Backup API
        const backupUrl = `https://api.giftedtech.my.id/api/download/dlmp3?url=${encodeURIComponent(videoUrl)}&apikey=gifted`;
        const backup = await axios.get(backupUrl);
        return backup.data.result?.download_url;
    } catch (e) {
        return null;
    }
}
