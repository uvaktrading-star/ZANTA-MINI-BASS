const { cmd } = require("../command");
const axios = require("axios");
const yts = require("yt-search");
const config = require("../config");

// Reply Handler à¶‘à¶š à¶œà¶¶à¶©à· à¶šà·’à¶»à·“à¶¸à¶§ à¶­à·à·€à¶šà·à¶½à·’à¶š Object à¶‘à¶šà¶šà·Š
const songReplyStore = {};

cmd({
    pattern: "song",
    alias: ["yta", "mp3", "play"],
    react: "ğŸ§",
    desc: "Download YouTube MP3 with selection menu",
    category: "download",
    filename: __filename,
}, async (bot, mek, m, { from, q, reply, userSettings, prefix }) => {
    try {
        if (!q) return reply("ğŸ§ *ZANTA-MD SONG SEARCH*\n\nExample: .song alone");

        const search = await yts(q);
        const video = search.videos[0];
        if (!video) return reply("âŒ No results found on YouTube.");

        const settings = userSettings || global.CURRENT_BOT_SETTINGS || {};
        const botName = settings.botName || config.DEFAULT_BOT_NAME || "ZANTA-MD";
        const isButtonsOn = settings.buttons === 'true';

        let msg = `ğŸµ *ZANTA AUDIO PLAYER* ğŸµ\n\n` +
                  `ğŸ“ *Title:* ${video.title}\n` +
                  `ğŸ‘¤ *Artist:* ${video.author.name}\n` +
                  `â±ï¸ *Duration:* ${video.timestamp}\n` +
                  `ğŸ”— *Link:* ${video.url}\n\n` +
                  (isButtonsOn ? `êœ±á´‡ÊŸá´‡á´„á´› ğŸ‘‡` : `*Reply with a number:* \n\n1ï¸âƒ£ *Audio File* (MPEG)\n2ï¸âƒ£ *Document File* (MP3)\n\n> *Â© ZANTA-MD SONG SERVICE*`);

        const contextInfo = {
            forwardingScore: 999,
            isForwarded: true,
            forwardedNewsletterMessageInfo: {
                newsletterJid: "120363406265537739@newsletter",
                newsletterName: "ğ’ğ‘¨ğ‘µğ‘»ğ‘¨-ğ‘´ğ‘« ğ‘¶ğ‘­ğ‘­ğ‘°ğ‘ªğ‘°ğ‘¨ğ‘³ </>",
                serverMessageId: 100
            }
        };

        if (isButtonsOn) {
            // --- BUTTONS LOGIC ---
            return await bot.sendMessage(from, {
                image: { url: video.thumbnail },
                caption: msg,
                footer: `Â© ${botName}`,
                buttons: [
                    { buttonId: `${prefix}ytsong_audio ${video.url}`, buttonText: { displayText: "ğŸµ AUDIO" }, type: 1 },
                    { buttonId: `${prefix}ytsong_doc ${video.url}`, buttonText: { displayText: "ğŸ“‚ DOCUMENT" }, type: 1 }
                ],
                headerType: 4,
                contextInfo
            }, { quoted: mek });
        } else {
            // --- REPLY SELECTION LOGIC ---
            const sentMsg = await bot.sendMessage(from, { 
                image: { url: video.thumbnail }, 
                caption: msg,
                contextInfo
            }, { quoted: mek });

            // à¶¸à·š à¶¸à·à·ƒà·šà¶¢à·Š à¶‘à¶šà·š ID à¶‘à¶šà¶§ à¶…à¶¯à·à·…à·€ à·€à·“à¶©à·’à¶ºà· à¶½à·’à¶±à·Šà¶šà·Š à¶‘à¶š à¶¸à¶­à¶š à¶­à¶¶à· à¶œà·à¶±à·“à¶¸
            const messageId = sentMsg.key.id;
            songReplyStore[messageId] = video.url;

            // à·€à·’à¶±à·à¶©à·’ 5 à¶šà·’à¶±à·Š à¶¸à¶­à¶šà¶ºà·™à¶±à·Š à¶‰à·€à¶­à·Š à¶šà¶»à¶±à·Šà¶±
            setTimeout(() => { delete songReplyStore[messageId]; }, 5 * 60 * 1000);
        }
        
    } catch (e) {
        reply("âŒ *Error:* " + e.message);
    }
});

// --- à¶¸à·à·ƒà·šà¶¢à·Š à¶‘à¶šà¶šà¶§ à¶»à·’à¶´à·Šà¶½à¶ºà·’ à¶šà·… à·€à·’à¶§ à¶šà·Šâ€à¶»à·’à¶ºà·à¶­à·Šà¶¸à¶š à·€à¶± à¶šà·œà¶§à·ƒ ---
// à¶¸à·™à¶º index.js à·„à·’ à·€à·™à¶±à·ƒà·Šà¶šà¶¸à·Š à¶…à·€à·à·Šâ€à¶º à¶±à·œà·€à¶± à¶´à¶»à·’à¶¯à·’ à·ƒà¶šà·ƒà· à¶‡à¶­
cmd({
    on: "text"
}, async (bot, mek, m, { from, body, reply, prefix }) => {
    if (!m.quoted || !songReplyStore[m.quoted.id]) return;

    const videoUrl = songReplyStore[m.quoted.id];
    const choice = body.trim();

    if (choice === "1") {
        delete songReplyStore[m.quoted.id]; // à¶‘à¶š à¶´à·à¶»à¶šà·Š à¶´à·à·€à·’à¶ à·Šà¶ à·’ à¶šà·… à¶´à·ƒà·” à¶¸à¶šà· à¶¯à¶¸à¶±à·Šà¶±
        await downloadAndSend(bot, mek, from, videoUrl, "audio", reply);
    } else if (choice === "2") {
        delete songReplyStore[m.quoted.id];
        await downloadAndSend(bot, mek, from, videoUrl, "document", reply);
    }
});

// à¶´à·œà¶¯à·” à¶©à·€à·”à¶±à·Šà¶½à·à¶©à·Š à·†à¶±à·Šà¶šà·Šà·‚à¶±à·Š à¶‘à¶š
async function downloadAndSend(bot, mek, from, url, type, reply) {
    try {
        await mek.react("ğŸ“¥");
        const downloadUrl = await getDownloadLink(url);
        if (!downloadUrl) return reply("âŒ Download link not found.");

        if (type === "audio") {
            await bot.sendMessage(from, { 
                audio: { url: downloadUrl }, 
                mimetype: "audio/mpeg", 
                ptt: false 
            }, { quoted: mek });
        } else {
            await bot.sendMessage(from, { 
                document: { url: downloadUrl }, 
                mimetype: "audio/mpeg", 
                fileName: `ZANTA-MD_SONG.mp3`,
                caption: "> *Â© Generated by ZANTA-MD*"
            }, { quoted: mek });
        }
        await mek.react("âœ…");
    } catch (e) {
        reply("âŒ Error: " + e.message);
    }
}

async function getDownloadLink(videoUrl) {
    try {
        const apiUrl = `https://api-site-x-by-manul.vercel.app/convert?mp3=${encodeURIComponent(videoUrl)}&apikey=Manul-Official`;
        const response = await axios.get(apiUrl);
        if (response.data?.status && response.data.data?.url) return response.data.data.url;

        const backupUrl = `https://api.giftedtech.my.id/api/download/dlmp3?url=${encodeURIComponent(videoUrl)}&apikey=gifted`;
        const backup = await axios.get(backupUrl);
        return backup.data.result?.download_url;
    } catch (e) { return null; }
}
