const { cmd } = require("../command");
const axios = require("axios");
const yts = require("yt-search");
const config = require("../config");

cmd({
    pattern: "song",
    alias: ["yta", "mp3", "play"],
    react: "ğŸ§",
    desc: "Download YouTube MP3 with selection menu",
    category: "download",
    filename: __filename,
}, async (bot, mek, m, { from, q, reply, userSettings, prefix }) => {
    try {
        if (!q) return reply("ğŸ§ *ZANTA-MD SONG SEARCH*\n\nExample: .song alone");

        const search = await yts(q);
        const video = search.videos[0];
        if (!video) return reply("âŒ No results found on YouTube.");

        const settings = userSettings || global.CURRENT_BOT_SETTINGS || {};
        const botName = settings.botName || config.DEFAULT_BOT_NAME || "ZANTA-MD";
        const isButtonsOn = settings.buttons === 'true';

        let msg = `ğŸµ *ZANTA AUDIO PLAYER* ğŸµ\n\n` +
                  `ğŸ“ *Title:* ${video.title}\n` +
                  `ğŸ‘¤ *Artist:* ${video.author.name}\n` +
                  `â±ï¸ *Duration:* ${video.timestamp}\n` +
                  `ğŸ”— *Link:* ${video.url}\n\n` +
                  (isButtonsOn ? `êœ±á´‡ÊŸá´‡á´„á´› ğŸ‘‡` : `*Reply with a number:* \n\n1ï¸âƒ£ *Audio File* (MPEG)\n2ï¸âƒ£ *Document File* (MP3)\n\n> *Â© ZANTA-MD SONG SERVICE*`);

        const contextInfo = {
            forwardingScore: 999,
            isForwarded: true,
            forwardedNewsletterMessageInfo: {
                newsletterJid: "120363406265537739@newsletter",
                newsletterName: "ğ’ğ‘¨ğ‘µğ‘»ğ‘¨-ğ‘´ğ‘« ğ‘¶ğ‘­ğ‘­ğ‘°ğ‘ªğ‘°ğ‘¨ğ‘³ </>",
                serverMessageId: 100
            }
        };

        if (isButtonsOn) {
            // --- BUTTONS à¶´à·™à¶±à·Šà·€à·“à¶¸ ---
            return await bot.sendMessage(from, {
                image: { url: video.thumbnail },
                caption: msg,
                footer: `Â© ${botName} â€¢ Song Downloader`,
                buttons: [
                    { buttonId: `${prefix}ytsong_audio ${video.url}`, buttonText: { displayText: "ğŸµ AUDIO" }, type: 1 },
                    { buttonId: `${prefix}ytsong_doc ${video.url}`, buttonText: { displayText: "ğŸ“‚ DOCUMENT" }, type: 1 }
                ],
                headerType: 4,
                contextInfo
            }, { quoted: mek });
        } else {
            // --- REPLY MENU (Selection) à¶´à·™à¶±à·Šà·€à·“à¶¸ ---
            const sentMsg = await bot.sendMessage(from, { 
                image: { url: video.thumbnail }, 
                caption: msg,
                contextInfo
            }, { quoted: mek });

            // index.js à¶‘à¶šà·š logic à¶‘à¶šà¶§ à·„à·ƒà·” à·€à·“à¶¸à¶§ ID à¶‘à¶š Save à¶šà·’à¶»à·“à¶¸
            // à¶¸à·™à¶­à¶± Map à¶‘à¶šà·š à¶±à¶¸ index.js à¶‘à¶šà·š à¶±à¶¸à¶§ à·ƒà¶¸à·à¶± à·€à·’à¶º à¶ºà·”à¶­à·”à¶ºà·’
            if (global.lastSongMessage) {
                global.lastSongMessage.set(from, sentMsg.key.id);
                setTimeout(() => global.lastSongMessage.delete(from), 3 * 60 * 1000);
            }
        }
        
    } catch (e) {
        console.log("SONG ERROR:", e);
        reply("âŒ *Error:* " + e.message);
    }
});

// --- 1. AUDIO FILE HANDLER ---
cmd({
    pattern: "ytsong_audio",
    dontAddCommandList: true,
    filename: __filename,
}, async (bot, mek, m, { from, q, reply }) => {
    try {
        if (!q) return;
        await m.react("ğŸ“¥");
        const finalLink = await getDownloadLink(q);
        if (!finalLink) return reply("âŒ Download link not found.");

        await bot.sendMessage(from, { 
            audio: { url: finalLink }, 
            mimetype: "audio/mpeg", 
            ptt: false 
        }, { quoted: mek });
        await m.react("âœ…");
    } catch (e) { reply("âŒ Audio Error"); }
});

// --- 2. DOCUMENT FILE HANDLER ---
cmd({
    pattern: "ytsong_doc",
    dontAddCommandList: true,
    filename: __filename,
}, async (bot, mek, m, { from, q, reply }) => {
    try {
        if (!q) return;
        await m.react("ğŸ“¥");
        const finalLink = await getDownloadLink(q);
        if (!finalLink) return reply("âŒ Download link not found.");

        await bot.sendMessage(from, { 
            document: { url: finalLink }, 
            mimetype: "audio/mpeg", 
            fileName: `ZANTA-MD_SONG.mp3`,
            caption: "> *Â© Generated by ZANTA-MD*"
        }, { quoted: mek });
        await m.react("âœ…");
    } catch (e) { reply("âŒ Document Error"); }
});

async function getDownloadLink(videoUrl) {
    try {
        const apiUrl = `https://api-site-x-by-manul.vercel.app/convert?mp3=${encodeURIComponent(videoUrl)}&apikey=Manul-Official`;
        const response = await axios.get(apiUrl);
        if (response.data?.status && response.data.data?.url) return response.data.data.url;

        const backupUrl = `https://api.giftedtech.my.id/api/download/dlmp3?url=${encodeURIComponent(videoUrl)}&apikey=gifted`;
        const backup = await axios.get(backupUrl);
        return backup.data.result?.download_url;
    } catch (e) { return null; }
}
