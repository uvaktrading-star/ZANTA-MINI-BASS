const { cmd } = require("../command");
const axios = require("axios");
const yts = require("yt-search");
const config = require("../config");

cmd({
    pattern: "video",
    alias: ["mp4", "ytv"],
    react: "üé•",
    desc: "Download YouTube Video with quality selection",
    category: "download",
    filename: __filename,
}, async (bot, mek, m, { from, q, reply, prefix }) => {
    try {
        if (!q) return reply("üé• *ZANTA-MD VIDEO SEARCH*\n\nExample: .video alone");

        const search = await yts(q);
        const video = search.videos[0];
        if (!video) return reply("‚ùå No results found on YouTube.");

        let msg = `üé• *ZANTA VIDEO PLAYER* üé•\n\n` +
                  `üìù *Title:* ${video.title}\n` +
                  `üë§ *Channel:* ${video.author.name}\n` +
                  `‚è±Ô∏è *Duration:* ${video.timestamp}\n` +
                  `üîó *Link:* ${video.url}\n\n` +
                  `*Reply with a quality number:* \n\n` +
                  `1Ô∏è‚É£ *360p* (Low Quality)\n` +
                  `2Ô∏è‚É£ *480p* (Medium Quality)\n` +
                  `3Ô∏è‚É£ *720p* (HD Quality)\n\n` +
                  `> *¬© ZANTA-MD VIDEO SERVICE*`;

        const sentMsg = await bot.sendMessage(from, { 
            image: { url: video.thumbnail }, 
            caption: msg 
        }, { quoted: mek });

        const listener = async (update) => {
            const msgUpdate = update.messages[0];
            if (!msgUpdate.message) return;

            const body = msgUpdate.message.conversation || 
                         msgUpdate.message.extendedTextMessage?.text;

            const isReplyToBot = msgUpdate.message.extendedTextMessage?.contextInfo?.stanzaId === sentMsg.key.id;

            if (isReplyToBot && ['1', '2', '3'].includes(body)) {
                await bot.sendMessage(from, { react: { text: '‚è≥', key: msgUpdate.key } });

                let quality = "360";
                if (body === '1') quality = "360";
                else if (body === '2') quality = "480";
                else if (body === '3') quality = "720";

                try {
                    const apiUrl = `https://sai-green.vercel.app/manump4?url=${encodeURIComponent(video.url)}&quality=${quality}`;
                    const response = await axios.get(apiUrl);
                    
                    // --- ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂ö‡∑Ö ‡∂Ω‡∑í‡∂±‡∑ä‡∂ö‡∑ä ‡∂ë‡∂ö ‡∂Ω‡∂∂‡∑è ‡∂ú‡∂±‡∑ä‡∂±‡∑è ‡∂¥‡∑ö‡∑Ö‡∑í‡∂∫ ---
                    // API ‡∂ë‡∂ö‡∑ö JSON structure ‡∂ë‡∂ö‡∂ß ‡∂Ö‡∂±‡∑î‡∑Ä: download -> url
                    const downloadUrl = response.data.download?.url;

                    if (!downloadUrl) {
                        return reply(`‚ùå Error: ${quality}p quality link not found in API response!`);
                    }

                    await bot.sendMessage(from, { 
                        video: { url: downloadUrl }, 
                        mimetype: "video/mp4",
                        caption: `üìù ${video.title}\n‚úÖ Quality: ${quality}p\n\n> *¬© Generated by ZANTA-MD*`
                    }, { quoted: msgUpdate });

                    await bot.sendMessage(from, { react: { text: '‚úÖ', key: msgUpdate.key } });

                } catch (err) {
                    console.error(err);
                    reply("‚ùå ‡∑Ä‡∑ì‡∂©‡∑í‡∂∫‡∑ù‡∑Ä ‡∂Ω‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∑ö‡∂Ø‡∑ì ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∑É‡∑í‡∂Ø‡∑î ‡∑Ä‡∑í‡∂∫.");
                }

                bot.ev.off('messages.upsert', listener);
            }
        };

        bot.ev.on('messages.upsert', listener);

        setTimeout(() => {
            bot.ev.off('messages.upsert', listener);
        }, 300000);

    } catch (e) {
        console.log("VIDEO ERROR:", e);
        reply("‚ùå *Error:* " + e.message);
    }
});
